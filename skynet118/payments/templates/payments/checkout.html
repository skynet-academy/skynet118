{% extends 'payments/base_payment.html' %}
{% load static %}
{% block payment_content %}
	<a class="go-pricing" href="{% url 'courses:index_course' %}">Come back to Courses</a>
	<div class="container-products">
       <div class="img-product">
	      <img src="{{ course.image.url }}" alt="{{course.course_name}}">
       </div>
       <div class="purchase-info">
          <h3>{{ course.course_name }} course</h3>
		  <p>Number of lessons: {{package.nro_lessons}}</p>
		  <p>You are buying a <strong>{{package.package_name}}</strong> package</p>
          <h4 class="product-price" >Total: ${{package.price}} </h4>
          <div id="paypal-button-container">
          </div>
       </div>
    </div>
    <hr>
	<div class="wise">
		<h3 class="wise-text">If you want to pay using Wise, please use this link.</h3>
		<a href="https://wise.com/invite/u/nicolass337" target="_blank">Go to Wise</a>
		<div class="bank-accounts">
			<h3>Also you can transfer me using the following accounts:</h3>
			<label for="banks">Select an account</label>
			<select id="bank-account" name="banks" onchange="changeAccount(this.value)">
				<option disabled selected value>Select an option</option>
				<option value="usa">USA</option>
				<option value="canada">CANADA</option>
				<option value="europe">EU</option>
			</select>
			<div id="info-account"></div>
		</div>
	</div>
	<script src="{% static 'payments/js/accounts.js' %}"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=AZtrmMXHZ-sTMmTsk3eIzoItkqZTXFXvUo74qInK8MZbOcCsZDlJ0as3qRRSDHVIpbrEJtywf_JH-Dda&currency=USD"></script>
    <script>
        function getCookie(name){
            let cookieValue = null;
        	if (document.cookie && document.cookie !== '') {
            	const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
        			}
            	}
        	}
        	return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');
        let total = '{{package.price}}'
        let course_id = '{{course.id}}'
        //function complete_order(){
        //    let url = "{% url 'payments:complete' %}"
        //    fetch(url, {
        //        method: 'POST',
        //        headers: {
        //            'Content-type':'application/json',
        //            'X-CSRFToken':csrftoken,
        //        },
        //        body: JSON.stringify({'course_id': course_id})
        //    })
        //}
        // Render the PayPal button into #paypal-button-container
        paypal.Buttons({
            style: {
                shape: 'rect',
                color: 'blue',
                layout: 'vertical',
                label: 'buynow',
            },
            // Set up the transaction
            createOrder: function(data, actions) {
                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: total 
                        }
                    }]
                });
            },
            // Finalize the transaction
            onApprove: function(data) {
                return fetch('/payments/checkout/{{course.id}}/{{package.package_name}}/', 
                {
                method: 'POST',
                headers: {'content-type': 'application/json', 'X-CSRFToken':csrftoken},
                body: JSON.stringify({orderID: data.orderID })
             }).then(function(res){
                return res.json();
             }).then(function(details) {
                alert(details.message);}
            )}
            //onApprove: function(data, actions) {
            //    return actions.order.capture().then(function(orderData) {
            //        // Successful capture! For demo purposes:
            //        console.log('Capture result', orderData, JSON.stringify(orderData, null, 2));
            //        var transaction = orderData.purchase_units[0].payments.captures[0];
            //        complete_order()
            //        alert('Transaction '+ transaction.status + ': ' + transaction.id + '\n\nSee console for all available details');
            //        // Replace the above to show a success message within this page, e.g.
            //        // const element = document.getElementById('paypal-button-container');
            //        // element.innerHTML = '';
            //        // element.innerHTML = '<h3>Thank you for your payment!</h3>';
            //        // Or go to another URL:  actions.redirect('thank_you.html');
            //    });
            //}
        }).render('#paypal-button-container');
    </script>
{% endblock payment_content %}
